name: Build, Push to Docker Hub, and Deploy to Cloud Run

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKERHUB_USERNAME: rrochlin
  CLIENT_IMAGE: docker.io/rrochlin/an-amazing-adventure-client
  SERVER_IMAGE: docker.io/rrochlin/an-amazing-adventure-server
  SHA_TAG: sha-${{ github.sha }}
  CLIENT_SERVICE: an-amazing-adventure
  SERVER_SERVICE: an-amazing-adventure-server

jobs:
  build_client:
    name: Build & Push Client
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker meta (client)
        id: meta_client
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.CLIENT_IMAGE }}
          tags: |
            type=ref,event=tag
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build & Push client
        uses: docker/build-push-action@v6
        with:
          context: ./client
          file: ./client/dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.CLIENT_IMAGE }}:${{ env.SHA_TAG }}
            ${{ steps.meta_client.outputs.tags }}

  build_server:
    name: Build & Push Server
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker meta (server)
        id: meta_server
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.SERVER_IMAGE }}
          tags: |
            type=ref,event=tag
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build & Push server
        uses: docker/build-push-action@v6
        with:
          context: ./server
          file: ./server/dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.SERVER_IMAGE }}:${{ env.SHA_TAG }}
            ${{ steps.meta_server.outputs.tags }}

  deploy:
    name: Deploy to Cloud Run
    needs: [ build_client, build_server ]
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy client to Cloud Run
        run: |
          gcloud run deploy "${{ env.CLIENT_SERVICE }}" \
            --image "${{ env.CLIENT_IMAGE }}:${{ env.SHA_TAG }}" \
            --platform managed \
            --region "${{ secrets.GCP_REGION }}" \
            --project "${{ secrets.GCP_PROJECT_ID }}" \
            --allow-unauthenticated \
            --port 8080

      - name: Deploy server to Cloud Run  
        run: |
          gcloud run deploy "${{ env.SERVER_SERVICE }}" \
            --image "${{ env.SERVER_IMAGE }}:${{ env.SHA_TAG }}" \
            --platform managed \
            --region "${{ secrets.GCP_REGION }}" \
            --project "${{ secrets.GCP_PROJECT_ID }}" \
            --allow-unauthenticated \
            --port 8080


