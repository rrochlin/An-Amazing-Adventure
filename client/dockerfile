# Multi-stage Dockerfile for Vite (React) frontend

# --- Stage 1: Build the app
FROM --platform=$BUILDPLATFORM node:20-alpine AS builder
WORKDIR /app

# Enable pnpm via corepack (preferred over global install)
RUN corepack enable && corepack prepare pnpm@10.0.0 --activate

# Install deps using lockfile for reproducible builds
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile

# Copy source and build
COPY . .
RUN pnpm build

# --- Stage 2: Serve with Nginx (bind to $PORT for Cloud Run)
FROM --platform=$TARGETPLATFORM nginx:stable-alpine AS runner

# envsubst for templating PORT into nginx config
RUN apk add --no-cache gettext

# Cloud Run sets PORT. Default to 8080 for local runs.
ENV PORT=8080

# Remove default nginx site to avoid port conflicts
RUN rm -f /etc/nginx/conf.d/default.conf

# Copy static assets
COPY --from=builder /app/dist /usr/share/nginx/html

# Copy nginx template with SPA fallback
COPY nginx.conf.template /etc/nginx/conf.d/default.conf.template

EXPOSE 8080

# Render only $PORT to avoid replacing nginx vars like $uri
CMD sh -c 'envsubst "\$PORT" < /etc/nginx/conf.d/default.conf.template > /etc/nginx/conf.d/default.conf && nginx -g "daemon off;"'
